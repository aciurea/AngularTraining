"use strict";function setFilters(){$.getJSON("./filters.json",function(a){options.filters=a,$("#builder-basic").queryBuilder(options)})}function loadSessionParameters(){var a=$("#sessionParameters").val();return""!==a?JSON.parse(a):null}function AddValues(a){return{field:a.field,id:a.id,input:a.input,operator:a.operator,type:a.type,value:a.value}}function BeautifyLeft(a,b,c){var d=AddValues(a);return c.rules.push(d)}function BeautifyRight(a,b,c){var d=[],e=BeautifyExpression(a);return d.push(c),d.push(e),c={data:a.condition,not:a.not,rules:d}}function createJson(a,b){if(a.rules&&a.rules[0].condition){var c=BeautifyExpression(a.rules[0]);return void 0===b?c:b}var d=[],e=a.rules[0]&&a.rules[1]&&!a.rules[1].condition;return d.push(AddValues(a.rules[0])),b=e?{condition:a.condition,not:a.not,rules:d}:b.rules.push(d)}function BeautifyExpression(a,b){if(b=createJson(a,b),a.rules.length>1)for(var c=1;c<a.rules.length;c++)b=a.rules[c].condition?BeautifyRight(a.rules[c],c,b):BeautifyLeft(a.rules[c],c,b);return b}function loadExpressionFromServer(a){a||(a=$("#txtParseResult").val());var b=JSON.parse(a);b?(getData(b),$("#builder-basic").queryBuilder("setRules",b)):$("#builder-basic").queryBuilder("reset")}function getData(a){if(a.rules&&a.rules[0].condition&&getData(a.rules[0]),a.rules&&a.rules[0].condition&&a.rules[1]?getData(a.rules[1]):checkParameters(a.rules?a.rules[0]:a),a.rules&&a.rules.length>1&&!a.rules[0].condition)for(var b=0;b<a.rules.length;b++)a.rules[b].condition?getData(a.rules[b]):checkParameters(a.rules[b])}function checkParameters(a){var b=options.filters.some(function(b){return b.id===a.id});b||(options.filters.push({id:a.id,label:a.field,type:a.type,size:30}),$("#builder-basic").queryBuilder("destroy"),$("#builder-basic").queryBuilder(options))}function parseLeft(a,b,c,d,e){return e?("less"!==a.operator&&"greater"!==a.operator&&"greater_or_equal"!==a.operator&&"less_or_equal"!==a.operator||(b="("+b+")"),b=b.slice(0,-1),b+=" "+c+" "+parseRule(a)+")"):b+" "+c+" "+parseRule(a)}function parseRight(a,b,c,d,e){var f=parseData(a);return e?(b=b.slice(0,-1),a.not||1===a.rules.length?b+" "+d+" "+f+")":b+" "+d+" ("+f+"))"):a.not||1===a.rules.length?b+" "+d+" "+f:(f=" "+d+" ("+f+")",b+f)}function createExpression(a){if(a.rules&&a.rules[0].condition){if(a.not)return"NOT ("+parseData(a.rules[0])+")";var b="("+parseData(a.rules[0])+")";return 0!==b.indexOf("(NOT")&&0!==b.indexOf("((")||(b=b.slice(1,-1)),b}return a.not?"NOT "+parseRule(a.rules[0],a.not,a.rules.length):parseRule(a.rules[0],a.not)}function parseData(a){var b=void 0;if(b=createExpression(a),a.rules&&a.rules.length>1)for(var c=1;c<a.rules.length;c++)b=a.rules[c].condition?parseRight(a.rules[c],b,c,a.condition,a.not):parseLeft(a.rules[c],b,a.condition,c,a.not);return b}function parseRule(a,b,c){var d,e=getOperatorSymbol(a.operator);return e?e.isBasic?"integer"!==a.type||"less"!==a.operator&&"greater"!==a.operator&&"greater_or_equal"!==a.operator&&"less_or_equal"!==a.operator?(d="("+a.id+e.text+'"'+a.value+'")',b?1===c?d:"("+d+")":d):"("+a.id+e.text+a.value+")":b?"("+e.text+"("+a.id+"))":e.text+"("+a.id+")":""}function getOperatorSymbol(a){switch(a){case"equal":return{text:"=",isBasic:!0};case"not_equal":return{text:"<>",isBasic:!0};case"less":return{text:"<",isBasic:!0};case"less_or_equal":return{text:"<=",isBasic:!0};case"greater":return{text:">",isBasic:!0};case"greater_or_equal":return{text:">=",isBasic:!0};case"equal_ignore_case":return{text:"=^",isBasic:!0};case"contains":return{text:"=%",isBasic:!0};case"contains_ignore_case":return{text:"=%^",isBasic:!0};case"regex_match":return{text:"=$%",isBasic:!0};case"exists":return{text:"Exists",isBasic:!1};default:console.log("Not implemented operator: "+a)}return null}function getOperator(a){switch(a){case"=":return{text:"equal",isBasic:!0};case"<>":return{text:"not_equal",isBasic:!0};case"<":return{text:"less",isBasic:!0};case"<=":case"=<":return{text:"less_or_equal",isBasic:!0};case">":return{text:"greater",isBasic:!0};case">=":case"=>":return{text:"greater_or_equal",isBasic:!0};case"=^":return{text:"equal_ignore_case",isBasic:!0};case"=%":return{text:"contains",isBasic:!0};case"=%^":case"=^%":return{text:"contains_ignore_case",isBasic:!0};case"=$%":return{text:"regex_match",isBasic:!0};case"Exists":return{text:"exists",isBasic:!1};default:console.log("Not implemented operator: "+operator)}return null}var _modules=require("modules");$(document).ready(function(){function a(a){var d=j(a),e=c(d,0);console.log(e);var f=b(e,a,0);return f}function b(a,c){var d=void 0;a instanceof Array||(a=new Array(a),a=a[0].couples);var f=!0,g=!1,h=void 0;try{for(var j,k=a[Symbol.iterator]();!(f=(j=k.next()).done);f=!0){var m=j.value;if(m.isGroup){var n=b(m,c),o=i(c,m.ClosePIndex);l+=1,d?d.rules.push(n):d={condition:o.operator,not:!1,rules:new Array(n)}}else if(!m.isGroup){var p=e(m,c,l),q=i(c,m.ClosePIndex);d||(d={condition:q.operator,not:!1,rules:[]}),d.rules.push(p),l=m.ClosePIndex+q.index}}}catch(a){g=!0,h=a}finally{try{!f&&k.return&&k.return()}finally{if(g)throw h}}return d}function c(a,b,e){var f=[],g=!0,h=!1,i=void 0;try{for(var j,k=a[Symbol.iterator]();!(g=(j=k.next()).done);g=!0){var l=j.value;if(l.ClosePIndex<=b&&!e);else if(l.isGroup){e=!0;var m=d(a,l);b=l.ClosePIndex;var n=c(m,b,e);if(e=!1,void 0==f.couples){var o={isGroup:!0,couples:n};f.push(o)}else{var p={isGroup:!0,couples:n};f.push(p)}}else f.push(l)}}catch(a){h=!0,i=a}finally{try{!g&&k.return&&k.return()}finally{if(h)throw i}}return f}function d(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value;i.ClosePIndex<b.ClosePIndex&&i.OpenPIndex>b.OpenPIndex&&c.push(i)}}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}return c}function e(a,b,c){var d=b.substring(c,a.OpenPIndex).trim();return 0===d.indexOf("(Exists")?(console.log("I've been here....."),c+=1,h(a,b)):0===d.indexOf("Exists")?h(a,b):g(a,b,c)}function f(a,b,c){var d,e=a.slice(c.OpenPIndex,c.ClosePIndex);k.some(function(a){var b=e.indexOf(a);return b!==-1&&(d=a),d});var f=a.indexOf(d,b);return{operator:d,index:f}}function g(a,b,c){var d=f(b,c,a),e=b.substring(a.OpenPIndex+1,d.index).trim(),g=b.substring(d.index+d.operator.length+1,a.ClosePIndex-1),h=getOperator(d.operator),i={operator:h.text,field:e.toLowerCase(),id:e,input:"text",type:"string",value:g.trim()};return i}function h(a,b){var c=b.substring(a.OpenPIndex+1,a.ClosePIndex);return{operator:"exists",field:c,id:c,input:"text",type:"string",value:null}}function i(a,b){var c=a.indexOf("OR",b);return c===-1||c-b>5?{index:5,operator:"AND"}:{index:4,operator:"OR"}}function j(a){a=a.trim();var b=-1,c=0,d=[],e=-1,f=!1,g=!0,h=!1,i=void 0;try{for(var j,k=a[Symbol.iterator]();!(g=(j=k.next()).done);g=!0){var l=j.value;if(b++,"("===l)c++,c>1&&d[d.length-1].ClosePIndex===-1&&(d[d.length-1].isGroup=!0),d.push({OpenPIndex:b,ClosePIndex:-1,isGroup:!1});else if(")"===l){for(e=d.length,f=!1;e>0;){if(d[e-1].ClosePIndex===-1){d[e-1].ClosePIndex=b,f=!0,c--;break}e--}if(f===!1)return"error"}}}catch(a){h=!0,i=a}finally{try{!g&&k.return&&k.return()}finally{if(h)throw i}}return d}$("#btnExpressionParser").on("click",function(){l=0;var b=$("#txtExpression").val(),c=a(b);console.log(c),$("#builder-basic").queryBuilder("setRules",c)});var k=["<>","=$%","<=","=<",">=","=>","=^%","=%^","=^","=%","=","<",">"],l=1}),$(document).ready(function(){var a=new _modules.Employee("gigel");console.log(a),setFilters(),$("#btnReset").on("click",function(){$("#txtParseResult").val(""),$("#builder-basic").queryBuilder("reset")}),$("#btnParse").on("click",function(){var a=$("#builder-basic").queryBuilder("getRules");if(console.log("Expression parsed is: ",a),!$.isEmptyObject(a)){var b=parseData(a);$("#txtExpression").val(b)}}),$("#btnOldImpl").click(function(){$("#oldContent").toggleClass("tglOldImpl"),$("i.glyphicon").toggleClass("glyphicon-menu-up").toggleClass("glyphicon-menu-down")})});var options={allow_empty:!1,plugins:{"not-group":null},filters:[],operators:[{type:"exists",nb_inputs:0,apply_to:["string","integer","datetime","boolean"]},{type:"equal"},{type:"equal_ignore_case",nb_inputs:1,apply_to:["string","datetime","boolean"]},{type:"not_equal"},{type:"less"},{type:"less_or_equal"},{type:"greater"},{type:"greater_or_equal"},{type:"contains"},{type:"contains_ignore_case",nb_inputs:1,apply_to:["string","datetime","boolean"]},{type:"regex_match",nb_inputs:1,apply_to:["string","number","datetime","boolean"]}],conditions:["AND","OR"],default_condition:"AND"};